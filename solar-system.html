<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Solar System Educational Experience</title>
    <link href="styles.css" rel="stylesheet" type="text/css">
</head>
<body>
    <a href="index.html" id="backButton">‚Üê Back to Resources</a>
    <canvas id="renderCanvas"></canvas>
    <div id="infoPanel"></div>
    <div id="instructions">
        <h3>Solar System Explorer</h3>
        <p>Click on planets to learn about them</p>
        <p>Use mouse to rotate view</p>
        <p>Scroll to zoom in/out</p>
        <p id="statusMsg"></p>
    </div>
    <button id="vrButton">Enter VR</button>
    <button id="arButton">Enter AR</button>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

    <script>
    window.addEventListener('DOMContentLoaded', function() {
        var canvas = document.getElementById("renderCanvas");
        var statusMsg = document.getElementById("statusMsg");
        var engine = new BABYLON.Engine(canvas, true);

        var planetInfo = {
            "Mercury": { distance: 13, size: 0.4, speed: 0.006, color: "#A9A9A9", info: "Mercury is the smallest..." },
            "Venus": { distance: 14, size: 0.9, speed: 0.007, color: "#FFFACD", info: "Venus is the second planet..." },
            "Earth": { distance: 17, size: 1, speed: 0.008, color: "#6495ED", info: "Earth is the third planet..." },
            "Mars": { distance: 22, size: 0.5, speed: 0.009, color: "#CD5C5C", info: "Mars is the fourth planet..." },
            "Jupiter": { distance: 57, size: 11, speed: 0.0002, color: "#F4A460", info: "Jupiter is the largest..." },
            "Saturn": { distance: 100, size: 9, speed: 0.0009, color: "#FFD700", info: "Saturn is the sixth..." }
        };

        var scene, camera, sun, planets = {}, planetAngles = {};

        function createScene() {
            scene = new BABYLON.Scene(engine);

            // Skybox
            var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size: 1000.0}, scene);
            var skyboxMaterial = new BABYLON.StandardMaterial("skyBoxMaterial", scene);
            skyboxMaterial.backFaceCulling = false;
            skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
            skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("https://assets.babylonjs.com/skyboxes/space", scene);
            skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            skybox.material = skyboxMaterial;

            // Camera
            camera = new BABYLON.ArcRotateCamera("Camera", -Math.PI / 2, Math.PI / 2, 75, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.upperBetaLimit = Math.PI / 1.5;
            camera.lowerRadiusLimit = 10;
            camera.upperRadiusLimit = 200;

            // Lights
            var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            var sunLight = new BABYLON.PointLight("sunLight", BABYLON.Vector3.Zero(), scene);
            sunLight.intensity = 0.8;
            sunLight.diffuse = new BABYLON.Color3(1, 0.8, 0.6);

            // Ground for VR teleportation
            var ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 200, height: 200}, scene);
            ground.isVisible = false;

            createSunAndPlanets();
            makePlanetsClickable();
            setupVRandAR(ground);

            return scene;
        }

        function createSunAndPlanets() {
            sun = BABYLON.MeshBuilder.CreateSphere("sun", {diameter: 20}, scene);
            var sunMaterial = new BABYLON.StandardMaterial("sunMaterial", scene);
            sunMaterial.emissiveColor = new BABYLON.Color3(1, 0.8, 0);
            sun.material = sunMaterial;
            new BABYLON.GlowLayer("glow", scene).intensity = 0.5;

            for (var name in planetInfo) {
                var info = planetInfo[name];
                var planet = BABYLON.MeshBuilder.CreateSphere(name, {diameter: info.size * 2}, scene);
                var material = new BABYLON.StandardMaterial(name + "Material", scene);
                material.diffuseColor = BABYLON.Color3.FromHexString(info.color);
                planet.material = material;
                planet.position.x = info.distance;

                var orbitPoints = [];
                for (var i = 0; i <= 60; i++) {
                    var angle = (i * Math.PI * 2) / 60;
                    orbitPoints.push(new BABYLON.Vector3(info.distance * Math.cos(angle), 0, info.distance * Math.sin(angle)));
                }
                var orbit = BABYLON.MeshBuilder.CreateLines("orbit", {points: orbitPoints}, scene);
                orbit.color = new BABYLON.Color3(0.5, 0.5, 0.5);
                orbit.alpha = 0.5;

                planets[name] = planet;
                planetAngles[name] = Math.random() * Math.PI * 2;
            }
        }

        function makePlanetsClickable() {
            var infoPanel = document.getElementById("infoPanel");

            sun.actionManager = new BABYLON.ActionManager(scene);
            sun.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger, function() {
                infoPanel.innerHTML = "<h3>Sun</h3><p>The Sun is the star at the center of the Solar System...</p>";
                infoPanel.style.display = "block";
            }));

            for (let name in planets) {
                planets[name].actionManager = new BABYLON.ActionManager(scene);
                planets[name].actionManager.registerAction(new BABYLON.ExecuteCodeAction(
                    BABYLON.ActionManager.OnPickTrigger,
                    () => {
                        infoPanel.innerHTML = "<h3>" + name + "</h3><p>" + planetInfo[name].info + "</p>";
                        infoPanel.style.display = "block";
                    }
                ));
            }

            scene.onPointerDown = function(evt, pickResult) {
                if (!pickResult.hit) infoPanel.style.display = "none";
            };
        }

        function setupVRandAR(ground) {
            var vrButton = document.getElementById("vrButton");
            var arButton = document.getElementById("arButton");

            if (!window.isSecureContext) {
                statusMsg.textContent = "WebXR requires HTTPS to work.";
                return;
            }

            scene.createDefaultXRExperienceAsync({
                floorMeshes: [ground]
            }).then(function(xrExperience) {
                vrButton.addEventListener("click", function() {
                    xrExperience.baseExperience.enterXRAsync("immersive-vr", "unbounded").catch(function(error) {
                        console.log("VR error:", error);
                        statusMsg.textContent = "Error entering VR.";
                    });
                });

                arButton.addEventListener("click", function() {
                    xrExperience.baseExperience.enterXRAsync("immersive-ar", "unbounded").catch(function(error) {
                        console.log("AR error:", error);
                        statusMsg.textContent = "Error entering AR.";
                    });
                });

                // Teleportation!
                xrExperience.teleportation = xrExperience.baseExperience.featuresManager.enableFeature(
                    BABYLON.WebXRFeatureName.TELEPORTATION,
                    "latest",
                    {
                        xrInput: xrExperience.input,
                        floorMeshes: [ground]
                    }
                );

                // Controller interaction
                xrExperience.input.onControllerAddedObservable.add(function(controller) {
                    controller.onMotionControllerInitObservable.add(function(motionController) {
                        var mainTrigger = motionController.getMainComponent();
                        if (mainTrigger) {
                            mainTrigger.onButtonStateChangedObservable.add(function(component) {
                                if (component.pressed) {
                                    var ray = new BABYLON.Ray(controller.pointer.position, controller.pointer.forward, 100);
                                    var hit = scene.pickWithRay(ray);
                                    if (hit.pickedMesh) {
                                        var meshName = hit.pickedMesh.name;
                                        if (meshName === "sun") {
                                            makeSimplePopup("Sun", "The Sun is the star at the center...");
                                        } else if (planetInfo[meshName]) {
                                            makeSimplePopup(meshName, planetInfo[meshName].info);
                                        }
                                    }
                                }
                            });
                        }
                    });
                });

                statusMsg.textContent = "VR/AR ready! Use the buttons below.";
            }).catch(function(error) {
                console.log("WebXR error:", error);
                statusMsg.textContent = "WebXR not supported.";
                vrButton.disabled = true;
                arButton.disabled = true;
            });
        }

        function makeSimplePopup(title, text) {
            var ui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
            var panel = new BABYLON.GUI.Rectangle();
            panel.width = "400px";
            panel.height = "200px";
            panel.cornerRadius = 20;
            panel.color = "white";
            panel.thickness = 4;
            panel.background = "black";
            ui.addControl(panel);

            var titleText = new BABYLON.GUI.TextBlock();
            titleText.text = title;
            titleText.color = "white";
            titleText.fontSize = 24;
            titleText.height = "30px";
            titleText.top = "-70px";
            panel.addControl(titleText);

            var bodyText = new BABYLON.GUI.TextBlock();
            bodyText.text = text;
            bodyText.color = "white";
            bodyText.fontSize = 16;
            bodyText.height = "120px";
            bodyText.top = "0px";
            bodyText.textWrapping = true;
            panel.addControl(bodyText);

            setTimeout(() => ui.dispose(), 5000);
        }

        function movePlanets() {
            for (var name in planets) {
                var planet = planets[name];
                var info = planetInfo[name];
                planetAngles[name] += info.speed;
                planet.position.x = info.distance * Math.cos(planetAngles[name]);
                planet.position.z = info.distance * Math.sin(planetAngles[name]);
                planet.rotation.y += 0.005;
            }
            sun.rotation.y += 0.001;
        }

        scene = createScene();
        engine.runRenderLoop(() => {
            movePlanets();
            scene.render();
        });

        window.addEventListener("resize", () => engine.resize());
    });
    </script>
</body>
</html>
